name: Automated tests #–Ω–∞–∑–≤–∞–Ω–∏–µ

on: # –∫–æ–≥–¥–∞ / –≤ –∫–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å
#  push # –∫–æ–≥–¥–∞ —Å–¥–µ–ª–∞–ª–∏ push
  workflow_dispatch:
    inputs: # –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
      deployment_target: # –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
        description: Choose target
        required: true # —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        default: login
        type: choice
        options:
          - login
          - run tests

# –î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ –Ω–∞ GitHub
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests: # –Ω–∞–∑–≤–∞–Ω–∏–µ job—ã 'tests'
    runs-on: windows-latest # –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–∫–∞–∑–∞–Ω–Ω—É—é –û–° –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
    continue-on-error: true

    steps: # —à–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
      - name: Checkout repository
        # 'uses' –∫–æ–≥–¥–∞ —Ö–æ—Ç–∏–º –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å action –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –∑–∞ –Ω–∞—Å / —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        uses: actions/checkout@v4
      - name: setup Python # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
        uses: actions/setup-python@v5
        with: # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ 'with'
          python-version: "3.11" # —É–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é python
      # - name: Install Chrome
        # 'run' –∫–æ–≥–¥–∞ —Å–∞–º–∏ —É–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
        # run: sudo apt-get install google-chrome-stable # —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é google-chrome
      - name: Install Latest Chrome
        shell: pwsh
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
          $installer = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $installer
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
          & $installer /silent /install
          
          # –ñ–¥—ë–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          Start-Sleep -Seconds 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (Test-Path $chromePath) {
            & $chromePath --version
          }

      - name: install dependencies # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: pip install -r requirements.txt

      - name: run tests
        if: "github.event.inputs.deployment_target == 'run tests'"
        # –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–æ 'options:- run tests'
        run: pytest --alluredir=allure-results
      - name: login
        if: "github.event.inputs.deployment_target == 'login'"
        run: pytest -m login --alluredir=allure-results
      - name: Store allure results # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á—ë—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path:
            allure-results
          retention-days: 1 # —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ 1 –¥–µ–Ω—å
        if: always()

  generate-report:
    runs-on: windows-latest
    needs: tests
    name: Generate Allure Reports
    steps:
      - name: Download allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: ./allure-results
      
      - name: Setup Java for Allure
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: ''
      
      - name: Install Allure (Download manually)
        shell: pwsh
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º Allure 2.24.0
          $allureVersion = "2.24.0"
          $url = "https://github.com/allure-framework/allure2/releases/download/$allureVersion/allure-$allureVersion.zip"
          $zipPath = "$env:TEMP\allure-$allureVersion.zip"
          $extractPath = "$env:TEMP\allure"
          
          Write-Host "Downloading Allure from: $url"
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          
          Write-Host "Extracting Allure..."
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          # –î–æ–±–∞–≤–ª—è–µ–º allure –≤ PATH –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
          $allureBinPath = "$extractPath\allure-$allureVersion\bin"
          $env:PATH = "$allureBinPath;$env:PATH"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤ PATH –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
          echo "$allureBinPath" | Out-File -FilePath $env:GITHUB_PATH -Append
          
          Write-Host "Allure installed successfully"
          allure --version
      
      - name: Generate Allure Report
        run: allure generate allure-results --clean -o ./_site

  publish-reports:
    runs-on: ubuntu-latest 
    needs: generate-report
    name: Deploy Allure Report to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # –°–∫–∞—á–∏–≤–∞–µ–º –æ—Ç—á—ë—Ç —Å Windows –º–∞—à–∏–Ω—ã
      - name: Download generated report
        uses: actions/download-artifact@v4
        with:
          name: allure-report  # –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–º—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
            
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      # –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –¥–ª—è Pages
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site  # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –æ—Ç—á–µ—Ç–æ–º
      
      # –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É
      - name: Show report URL
        run: |
          echo "=========================================="
          echo "‚úÖ Allure –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–µ–Ω!"
          echo "üìä –û—Ç—á–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ:"
          echo "   ${{ steps.deployment.outputs.page_url }}"
          echo "=========================================="
