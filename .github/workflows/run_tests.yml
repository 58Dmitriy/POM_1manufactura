name: Automated tests #–Ω–∞–∑–≤–∞–Ω–∏–µ

on: # –∫–æ–≥–¥–∞ / –≤ –∫–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å
#  push # –∫–æ–≥–¥–∞ —Å–¥–µ–ª–∞–ª–∏ push
  workflow_dispatch:
    inputs: # –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
      deployment_target: # –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
        description: Choose target
        required: true # —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        default: login
        type: choice
        options:
          - login
          - run tests

# –î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ –Ω–∞ GitHub
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests: # –Ω–∞–∑–≤–∞–Ω–∏–µ job—ã 'tests'
    runs-on: windows-latest # –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–∫–∞–∑–∞–Ω–Ω—É—é –û–° –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
    continue-on-error: true

    steps: # —à–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
      - name: Checkout repository
        # 'uses' –∫–æ–≥–¥–∞ —Ö–æ—Ç–∏–º –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å action –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –∑–∞ –Ω–∞—Å / —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        uses: actions/checkout@v4
      - name: setup Python # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
        uses: actions/setup-python@v5
        with: # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ 'with'
          python-version: "3.11" # —É–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é python
      # - name: Install Chrome
        # 'run' –∫–æ–≥–¥–∞ —Å–∞–º–∏ —É–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
        # run: sudo apt-get install google-chrome-stable # —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é google-chrome
      - name: Install Latest Chrome
        shell: pwsh
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
          $installer = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $installer
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
          & $installer /silent /install
          
          # –ñ–¥—ë–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          Start-Sleep -Seconds 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (Test-Path $chromePath) {
            & $chromePath --version
          }

      - name: install dependencies # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: pip install -r requirements.txt

      - name: run tests
        if: "github.event.inputs.deployment_target == 'run tests'"
        # –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–æ 'options:- run tests'
        run: pytest --alluredir=allure-results
      - name: login
        if: "github.event.inputs.deployment_target == 'login'"
        run: pytest -m login --alluredir=allure-results
      - name: Store allure results # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á—ë—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path:
            allure-results
          retention-days: 1 # —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ 1 –¥–µ–Ω—å
        if: always()

  generate-report:
    runs-on: windows-latest
    needs: tests
    name: Generate Allure Reports
    steps:
      - name: Download allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: ./allure-results
      
      - name: Setup Java for Allure
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: ''
      
      - name: Install Allure
        shell: pwsh
        run: |
          $allureVersion = "2.27.0"
          $url = "https://github.com/allure-framework/allure2/releases/download/$allureVersion/allure-$allureVersion.zip"
          $zipPath = "$env:TEMP\allure-$allureVersion.zip"
          $extractPath = "$env:TEMP\allure"
          
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          $allureBinPath = "$extractPath\allure-$allureVersion\bin"
          echo "$allureBinPath" | Out-File -FilePath $env:GITHUB_PATH -Append
          $env:PATH = "$allureBinPath;$env:PATH"
      
      - name: Check allure results
        shell: pwsh
        run: |
          Write-Host "–ü—Ä–æ–≤–µ—Ä–∫–∞ allure-results:"
          if (Test-Path "allure-results") {
            $files = Get-ChildItem "allure-results\" -Recurse -File
            Write-Host "–ù–∞–π–¥–µ–Ω–æ $($files.Count) —Ñ–∞–π–ª–æ–≤"
            if ($files.Count -gt 0) {
              $files | Select-Object -First 5 Name
            }
          } else {
            Write-Host "‚ùå –ü–∞–ø–∫–∞ allure-results –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          }
      
      - name: Generate Allure Report
        run: |
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
          allure generate allure-results --clean -o ./_site
          
          # –°–æ–∑–¥–∞–µ–º .nojekyll –¥–ª—è GitHub Pages
          touch ./_site/.nojekyll
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–æ—Å—å
          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ _site –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ==="
          find ./_site -type f | head -20
      
      - name: Verify report content
        shell: pwsh
        run: |
          Write-Host "–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞:"
          if (Test-Path "_site\index.html") {
            Write-Host "‚úÖ index.html –Ω–∞–π–¥–µ–Ω"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
            $size = (Get-Item "_site\index.html").Length
            Write-Host "–†–∞–∑–º–µ—Ä index.html: $size –±–∞–π—Ç"
          }
          
          if (Test-Path "_site\data") {
            $dataFiles = Get-ChildItem "_site\data" -Recurse -File
            Write-Host "‚úÖ –ù–∞–π–¥–µ–Ω–æ $($dataFiles.Count) —Ñ–∞–π–ª–æ–≤ –≤ data/"
          }
      
      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: _site
          retention-days: 1

  publish-reports:
    runs-on: ubuntu-latest
    needs: generate-report
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Download generated report
        uses: actions/download-artifact@v4
        with:
          name: allure-report
      
      - name: Fix for GitHub Pages
        run: |
          echo "=== –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è GitHub Pages ==="
          
          # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if [ -d "allure-report" ]; then
            mv allure-report _site
          fi
          
          # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ .nojekyll
          touch _site/.nojekyll
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ _site:"
          find _site -type f | head -30
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º index.html
          if [ -f "_site/index.html" ]; then
            echo "index.html –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫:"
            head -10 _site/index.html
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É data
          if [ -d "_site/data" ]; then
            echo "–ü–∞–ø–∫–∞ data –Ω–∞–π–¥–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤:"
            find _site/data -type f | wc -l
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Show deployment URL
        run: |
          echo "========================================"
          echo "‚úÖ Allure –æ—Ç—á–µ—Ç –∑–∞–¥–µ–ø–ª–æ–µ–Ω!"
          echo "üìä –°—Å—ã–ª–∫–∞: ${{ steps.deployment.outputs.page_url }}"
