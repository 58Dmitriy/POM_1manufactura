name: Automated tests #название

on: # когда / в какой ситуации запускать
#  push # когда сделали push
  workflow_dispatch:
    inputs: # для ручного запуска тестов
      deployment_target: # для настройки команды запуска тестов
        description: Choose target
        required: true # чтобы не было возможности запуска без конкретной команды
        default: login
        type: choice
        options:
          - login
          - run tests

# Для публикации отчётов на GitHub
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests: # название jobы 'tests'
    runs-on: windows-latest # в виртуальную машину установить указанную ОС последней версии
    continue-on-error: true

    steps: # шаги для запуска тестов
      - name: Checkout repository
        # 'uses' когда хотим задействовать action написанный за нас / уже существует
        uses: actions/checkout@v4
      - name: setup Python # устанавливаем Python
        uses: actions/setup-python@v5
        with: # дополнительная настройка 'with'
          python-version: "3.11" # указываем нужную версию python
      # - name: Install Chrome
        # 'run' когда сами указываем команду которую необходимо выполнить
        # run: sudo apt-get install google-chrome-stable # установить последнюю стабильную версию google-chrome
      - name: Install Latest Chrome
        shell: pwsh
        run: |
          # Скачиваем установщик
          $installer = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile $installer
          
          # Устанавливаем
          & $installer /silent /install
          
          # Ждём установки
          Start-Sleep -Seconds 10
          
          # Проверяем
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (Test-Path $chromePath) {
            & $chromePath --version
          }

      - name: install dependencies # устанавливаем зависимости
        run: pip install -r requirements.txt

      - name: run tests
        if: "github.event.inputs.deployment_target == 'run tests'"
        # запускать только когда выбрано 'options:- run tests'
        run: pytest --alluredir=allure-results
      - name: login
        if: "github.event.inputs.deployment_target == 'login'"
        run: pytest -m login --alluredir=allure-results
      - name: Store allure results # Сохраняем отчёт для дальнейшего скачивания
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path:
            allure-results
          retention-days: 1 # срок жизни 1 день
        if: always()

  generate-report:
    runs-on: windows-latest
    needs: tests
    name: Generate Allure Reports
    steps:
      - name: Download allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: ./allure-results
      
      - name: Setup Java for Allure
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: ''
      
      - name: Install Allure
        shell: pwsh
        run: |
          $allureVersion = "2.27.0"
          $url = "https://github.com/allure-framework/allure2/releases/download/$allureVersion/allure-$allureVersion.zip"
          $zipPath = "$env:TEMP\allure-$allureVersion.zip"
          $extractPath = "$env:TEMP\allure"
          
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          $allureBinPath = "$extractPath\allure-$allureVersion\bin"
          echo "$allureBinPath" | Out-File -FilePath $env:GITHUB_PATH -Append
          $env:PATH = "$allureBinPath;$env:PATH"
      
      - name: Check allure results
        shell: pwsh
        run: |
          Write-Host "Проверка allure-results:"
          if (Test-Path "allure-results") {
            $files = Get-ChildItem "allure-results\" -Recurse -File
            Write-Host "Найдено $($files.Count) файлов"
            if ($files.Count -gt 0) {
              $files | Select-Object -First 5 Name
            }
          } else {
            Write-Host "❌ Папка allure-results не найдена"
          }
      
      - name: Generate Allure Report
        run: |
          # Генерируем отчет
          allure generate allure-results --clean -o ./_site
          
          # Создаем .nojekyll для GitHub Pages
          touch ./_site/.nojekyll
          
          # Проверяем что сгенерировалось
          echo "=== Содержимое _site после генерации ==="
          find ./_site -type f | head -20
      
      - name: Verify report content
        shell: pwsh
        run: |
          Write-Host "Проверка отчета:"
          if (Test-Path "_site\index.html") {
            Write-Host "✅ index.html найден"
            # Проверяем размер
            $size = (Get-Item "_site\index.html").Length
            Write-Host "Размер index.html: $size байт"
          }
          
          if (Test-Path "_site\data") {
            $dataFiles = Get-ChildItem "_site\data" -Recurse -File
            Write-Host "✅ Найдено $($dataFiles.Count) файлов в data/"
          }
      
      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: _site
          retention-days: 1

  publish-reports:
    runs-on: ubuntu-latest
    needs: generate-report
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Download generated report
        uses: actions/download-artifact@v4
        with:
          name: allure-report
      
      - name: Create _site with all files
        run: |
          # Удаляем старую папку _site если есть
          rm -rf _site
          
          # Создаем новую папку _site
          mkdir -p _site
          
          # Копируем ВСЁ что есть в текущей папке в _site
          # (кроме самой папки _site)
          echo "Копируем файлы..."
          find . -maxdepth 1 -type f -exec cp {} _site/ \; 2>/dev/null || true
          find . -maxdepth 1 -type d ! -name "." ! -name "_site" -exec cp -r {} _site/ \; 2>/dev/null || true
          
          # Создаем обязательные файлы для GitHub Pages
          echo "Создаем .nojekyll..."
          touch _site/.nojekyll
          
          # Гарантируем наличие index.html
          if [ ! -f "_site/index.html" ]; then
            echo "Создаем index.html..."
            cat > _site/index.html << EOF
  <!DOCTYPE html>
  <html>
  <head>
      <title>Allure Test Report</title>
      <style>
          body { font-family: Arial, sans-serif; margin: 40px; }
          h1 { color: #333; }
          .info { background: #f5f5f5; padding: 20px; border-radius: 5px; }
      </style>
  </head>
  <body>
      <h1>Allure Test Report</h1>
      <div class="info">
          <p>Report generated by GitHub Actions</p>
          <p>If you see this page, the report files might be missing.</p>
          <p>Check the workflow logs for details.</p>
      </div>
  </body>
  </html>
  EOF
          fi
          
          echo "Итоговое содержимое _site:"
          ls -la _site/
          echo ""
          echo "Количество файлов: $(find _site -type f | wc -l)"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
